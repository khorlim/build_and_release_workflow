name: IOS Build & Upload AppHost

on:
  workflow_call:
    secrets:
      # --- GitHub Secrets ---
      PERSONAL_ACCESS_TOKEN:
        required: true
      # --- Fastlane Match Secrets ---
      MATCH_PASSWORD:
        required: true
      MATCH_GIT_BASIC_AUTHORIZATION: # Base64 of "username:token" for your cert repo
        required: true
      APP_STORE_CONNECT_API_KEY_KEY_ID:
        required: true
      APP_STORE_CONNECT_API_KEY_ISSUER_ID:
        required: true
      APP_STORE_CONNECT_API_KEY_KEY:
        required: true
      # --- Telegram Secrets ---
      TELEGRAMBOT_TOKEN:
        required: true
      TELEGRAM_CHATID:
        required: true
      TELEGRAM_TOPICID:
        required: true
      # --- AppHost Secrets ---
      APPHOST_USER_ID:
        required: true
      APPHOST_APP_ID:
        required: true
      APPHOST_KEY:
        required: true
      APPHOST_IOS_BUNDLE_IDENTIFIER:
        required: true

jobs:
  ios-distribute:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Configure Git auth for private dependencies
        run: |
          echo "machine github.com login x-access-token password ${{ secrets.PERSONAL_ACCESS_TOKEN }}" > ~/.netrc
          chmod 600 ~/.netrc

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.5"

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2

      - name: Install Bundler 2.x
        working-directory: ios
        run: gem install bundler -v 2.7.2

      - name: Install dependencies
        working-directory: ios
        run: bundle _2.7.2_ install

      - name: Install fastlane
        working-directory: ios
        run: bundle exec fastlane --version

      - name: Clean Derived Data
        run: rm -rf ~/Library/Developer/Xcode/DerivedData/*

      - name: Pod Install
        working-directory: ios
        run: bundle exec pod install --repo-update

      - name: Sync Certificates (Match)
        working-directory: ios
        run: bundle exec fastlane build_and_sign
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}

      # -----------------------
      # Upload
      # -----------------------
      - name: Upload to AppHost
        id: upload
        env:
          APPHOST_USER_ID: ${{ secrets.APPHOST_USER_ID }}
          APPHOST_APP_ID: ${{ secrets.APPHOST_APP_ID }}
          APPHOST_KEY: ${{ secrets.APPHOST_KEY }}
          APPHOST_IOS_BUNDLE_IDENTIFIER: ${{ secrets.APPHOST_IOS_BUNDLE_IDENTIFIER }}
        run: |
          # Extract version and app name from pubspec.yaml
          VERSION=$(grep -E "^version:" pubspec.yaml | sed -E 's/version:[[:space:]]*//' | tr -d '[:space:]')
          APP_NAME=$(grep -E "^name:" pubspec.yaml | sed -E 's/name:[[:space:]]*//' | tr -d '[:space:]')

          # Find the IPA file
          IPA_FILE=$(find build/ios/ipa -name "*.ipa" | head -n 1)
          if [ -z "$IPA_FILE" ]; then
            echo "Error: IPA file not found in build/ios/ipa/"
            exit 1
          fi

          echo "Found IPA file: $IPA_FILE"

          # Fetch upload URL (curl handles URL encoding automatically with -G and --data-urlencode)
          echo "Fetching upload URL..."
          UPLOAD_URL=$(curl -s -G "https://appho.st/api/get_upload_url" \
            --data-urlencode "user_id=${APPHOST_USER_ID}" \
            --data-urlencode "app_id=${APPHOST_APP_ID}" \
            --data-urlencode "key=${APPHOST_KEY}" \
            --data-urlencode "platform=ios" \
            --data-urlencode "version=${VERSION}" \
            --data-urlencode "ios_bundle_identifier=${APPHOST_IOS_BUNDLE_IDENTIFIER}")

          if [[ ! "$UPLOAD_URL" =~ ^https: ]]; then
            echo "Error fetching upload URL: $UPLOAD_URL"
            exit 1
          fi

          # Upload file
          echo "Uploading file..."
          FILE_SIZE=$(stat -f%z "$IPA_FILE")
          curl -X PUT "$UPLOAD_URL" \
            -H "Content-Type: application/octet-stream" \
            -H "Content-Length: $FILE_SIZE" \
            --data-binary "@$IPA_FILE" \
            --progress-bar

          echo ""
          echo "Upload complete! Install your app from:"
          echo ""

          # Get version info and print install URL
          VERSION_RESPONSE=$(curl -s -G "https://appho.st/api/get_current_version/" \
            --data-urlencode "u=${APPHOST_USER_ID}" \
            --data-urlencode "a=${APPHOST_APP_ID}" \
            --data-urlencode "platform=ios")
          if command -v jq &> /dev/null; then
            INSTALL_URL=$(echo "$VERSION_RESPONSE" | jq -r '.url')
          else
            INSTALL_URL=$(echo "$VERSION_RESPONSE" | grep -o '"url":"[^"]*"' | sed 's/"url":"\([^"]*\)"/\1/')
          fi
          echo "$INSTALL_URL"
          echo ""

          # Save install URL, version, and app name for Telegram step
          echo "INSTALL_URL=$INSTALL_URL" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Send Telegram message
        run: |
          VERSION="${{ steps.upload.outputs.VERSION }}"
          INSTALL_URL="${{ steps.upload.outputs.INSTALL_URL }}"
          APP_NAME="${{ steps.upload.outputs.APP_NAME }}"
          TEXT="ðŸš€ *New $APP_NAME is Built and Uploaded !*
          ðŸ“± *Version:* $VERSION
          ðŸ”— *Link:* $INSTALL_URL"

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAMBOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHATID }} \
            -d message_thread_id=${{ secrets.TELEGRAM_TOPICID }} \
            --data-urlencode "text=$TEXT" \
            -d parse_mode=Markdown
